<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
<title>Goban</title>
<link rel="icon" type="image/svg" href="icon.svg">
<link rel="apple-touch-icon" href="icon.png" sizes="192x192">
<script src="manifest.js"></script>
<style>
body {
	font-family: Courier, monospace, sans-serif;
	background-color: #fff;
}
a {
	color: #000;
	text-decoration: none;
}
#container {
	width: 100%; height: 100%;
	display: flex; display: -webkit-flex;
	flex-direction: column; -webkit-flex-direction: column;
	justify-content: flex-start; -webkit-justify-content: flex-start;
	align-items: center; -webkit-align-items: center;
}
#header {
	width: 95%; margin: 0px;
	flex: 0 1 auto;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: space-between; -webkit-justify-content: space-between;
	align-items: center; -webkit-align-items: center;
}
@media (max-width: 480px) {
	#contents {
		width: 95%; height: 90%;
		flex: 1 1 auto;
		display: grid; display: -webkit-grid;
		grid-template-columns: 50% 50%;
		background-color: #eee;
	}
	.mainScreen {
		width: 100%;
		grid-column: span 2;
		display: flex; display: -webkit-flex;
		flex-direction: column; -webkit-flex-direction: column;
		justify-content: center; -webkit-justify-content: center;
		align-items: center; -webkit-align-items: center;
	}
	.subScreen1 {
		order: 3;
		width: 100%;
		display: flex; display: -webkit-flex;
		flex-direction: column; -webkit-flex-direction: column;
		justify-content: center; -webkit-justify-content: center;
		align-items: center; -webkit-align-items: center;
	}
	.subScreen2 {
		order: 2;
		width: 100%;
		display: flex; display: -webkit-flex;
		flex-direction: column; -webkit-flex-direction: column;
		justify-content: center; -webkit-justify-content: center;
		align-items: center; -webkit-align-items: center;
	}
}
@media (min-width: 480px) {
	#contents {
		width: 95%; height: 90%;
		flex: 1 1 auto;
		display: grid; display: -webkit-grid;
		grid-template-columns: 20% 60% 20%;
		background-color: #eee;
	}
	.mainScreen {
		order: 2;
		width: 100%;
		display: flex; display: -webkit-flex;
		flex-direction: column; -webkit-flex-direction: column;
		justify-content: center; -webkit-justify-content: center;
		align-items: center; -webkit-align-items: center;
	}
	.subScreen1 {
		order: 3;
		width: 100%;
		display: flex; display: -webkit-flex;
		flex-direction: column; -webkit-flex-direction: column;
		justify-content: center; -webkit-justify-content: center;
		align-items: center; -webkit-align-items: center;
	}
	.subScreen2 {
		order: 1;
		width: 100%;
		display: flex; display: -webkit-flex;
		flex-direction: column; -webkit-flex-direction: column;
		justify-content: center; -webkit-justify-content: center;
		align-items: center; -webkit-align-items: center;
	}
}
#footer {
	width: 95%; margin: 0px;
	flex: 0 1 auto;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: flex-end; -webkit-justify-content: flex-end;
	align-items: center; -webkit-align-items: center;
}
#version {
	font-size: 12px;
	opacity: 0.1;
}
.logo {
	width: 160px; height: 60px; margin: 0px 16px;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: flex-start; -webkit-justify-content: flex-start;
	align-items: center; -webkit-align-items: center;
	font-size: 24px;
}
.logo .icon {
    width: 40px; height: 40px; padding: 10px; margin-left: -28px;
}
.menu {
	width: 160px; height: 40px; margin: 5px 0px;
	display: flex; display: -webkit-flex;
	flex-direction: row; -webkit-flex-direction: row;
	justify-content: space-between; -webkit-justify-content: space-between;
	align-items: flex-end; -webkit-align-items: flex-end;
	background-color: #888;
}
.menu a {
	width: 40px; height: 40px;
	display: flex; display: -webkit-flex;
	flex-direction: column; -webkit-flex-direction: column;
	justify-content: center; -webkit-justify-content: center;
	align-items: center; -webkit-align-items: center;
	font-size: 20px;
	color: #fff;
	text-decoration: none;
	transform: scale(1);
}
.menu a:hover {
	transform: scale(0.9);
}
.menu a:active {
	transform: scale(0.8);
}
</style>
</head>
<body>
<div id="container">
	<h1 id="header">
		<div class="logo">
			<!--img class="icon" src="icon.svg"/!-->
			<a href="?">Goban</a>
		</div>
		<div class="menu">
			<a id="x6" href="javascript:setLevel(6);">¡Á6</a>
			<a id="x7" href="javascript:setLevel(7);">¡Á7</a>
			<a id="x8" href="javascript:setLevel(8);">¡Á8</a>
			<a id="x9" href="javascript:setLevel(9);">¡Á9</a>
		</div>
	</h1>
	<div id="contents">
		<div class="mainScreen"></div>
		<div class="subScreen1"></div>
		<div class="subScreen2"></div>
	</div>
	<h6 id="footer">
		<div id="version">.</div>
	</h6>
</div>
<script src="cube-api-0.8.js"></script>
<!--Menu--><script>
	//console.log = () => {};
	document.getElementById("version").innerText = manifest.version.substr(-4);

	// Get query parameters.
	var params = cubeParamNumbers("x");
	var levelMax = params[1] > 9 ? params[1] : 9;
	var level = params[1] ? params[1] : 6; // Goban lines.
	var playing = 0; // Playing count.

	// Set playing level.
	var setLevel = (x) => {
        level = x >= 1 && x <= levelMax ? x : 6;
        for (let i = 1; i <= levelMax; ++i) {
            let menu = document.getElementById("x" + i);
            if (menu) {
				menu.style.backgroundColor = i == level ? "#000" : "#888";
			}
        }
		playing = -1; // Replay.
	};

	// Initialize settings.
	setLevel(level);
</script><!--/Menu-->
<!--Main--><script>(async()=>{

	// Create screens.
	const screenWidth = 300;
	const screenHeight = 280;
	var mainScreen = cubeScreen("mainScreen", screenWidth, screenHeight);
	var mainJoypad = cubeJoypad(mainScreen);
	const subScreenWidth = 30;
	const subScreenHeight = 30;
	var subScreens = [], subJoypads = [];
	for (var i = 0; i < 2; i++) {
		subScreens[i] = cubeScreen("subScreen" + (i + 1), subScreenWidth, subScreenHeight);
		subJoypads[i] = cubeJoypad(subScreens[i]);
	}

	// Create goban sprites.
	var sprite = await cubeSprite("resource.svg", 24, 24);
	var gobans = [], gobansIndex = [], piecesIndex = [];
	for (var i = 0; i < levelMax * levelMax; i++) {
		gobans[i] = await cubeSprite("resource.svg", 24, 24);
	}
	const gobansWidth = 250;
	var gokes = [];
	for (var i = 0; i < 2; i++) {
		gokes[i] = await cubeSprite("resource.svg", 24, 24);
	}
	var teban = 10;
	const piecesWidth = 20;

	// Main loop.
	while (true) {

		// Initialize pieces.
		for (var i = 0; i < levelMax * levelMax; i++) {
			gobansIndex[i] = 0;
			piecesIndex[i] = 0;
		}
		var gobansType = cubeMod(level, 2);
		for (let y = 0; y < level; y++) {
			for (let x = 0; x < level; x++) {
				if (gobansType > 0) {
					if (y == 0) {
						if (x == 0) {
							gobansIndex[level*y+x] = 1;
						} else if (x == level - 1) {
							gobansIndex[level*y+x] = 3;
						} else {
							gobansIndex[level*y+x] = 2;
						}
					} else if (y == level - 1) {
						if (x == 0) {
							gobansIndex[level*y+x] = 7;
						} else if (x == level - 1) {
							gobansIndex[level*y+x] = 9;
						} else {
							gobansIndex[level*y+x] = 8;
						}
					} else {
						if (x == 0) {
							gobansIndex[level*y+x] = 4;
						} else if (x == level - 1) {
							gobansIndex[level*y+x] = 6;
						} else {
							gobansIndex[level*y+x] = 5;
						}
					}
				} else {
					gobansIndex[level*y+x] = 0;
				}
			}
		}

		for (playing = 1; playing >= 1; ) {

			// Update gobans.
			let scale = gobansWidth / (piecesWidth * (gobansType > 0 ? level - 1 : level));
			let piecesWidthScaled = piecesWidth * scale;
			let ox = (screenWidth - gobansWidth) / 2 + (gobansType > 0 ? 0 : piecesWidthScaled / 2);
			let oy = (screenHeight - gobansWidth) / 2 + (gobansType > 0 ? 0 : piecesWidthScaled / 2);
			for (let y = 0; y < level; y++) {
				for (let x = 0; x < level; x++) {
					let gx = ox + piecesWidthScaled * x;
					let gy = oy + piecesWidthScaled * y;
					cubeMove(gx, gy, gobans[level*y+x]);
					cubeExpand(scale, gobans[level*y+x]);
					cubeDilute(1, gobans[level*y+x]);
					cubeAnimate(gobansIndex[level*y+x] + piecesIndex[level*y+x], gobans[level*y+x]);
				}
			}

			// Read input.
			await cubeReadJoypad(0, mainJoypad);
			let motion = cubeJoypadMotion(mainJoypad);
			let motionIndex = -1;
			let action = cubeJoypadAction(mainJoypad);
			if (motion) {
				let mx = cubeDiv(motion.x - (ox - piecesWidthScaled / 2), piecesWidthScaled);
				let my = cubeDiv(motion.y - (oy - piecesWidthScaled / 2), piecesWidthScaled);
				if (my >= 0 && my < level) {
					if (mx >= 0 && mx < level) {
						motionIndex = level*my+mx;
						cubeDilute(0.2, gobans[motionIndex]);
						if (action) {
							if (piecesIndex[motionIndex] != teban) {
								piecesIndex[motionIndex] = teban;
							} else {
								piecesIndex[motionIndex] = 0;
							}
						}
					}
				}
			}


			// Update pieces.
			for (var i = 0; i < 2; i++) {

				// Read input.
				await cubeReadJoypad(0, subJoypads[i]);
				let motion = cubeJoypadMotion(subJoypads[i]);
				if (motion) {
					let mx = motion.x - subScreenWidth / 2;
					let my = motion.y - subScreenHeight / 2;
					if (-piecesWidth <= mx && mx <= piecesWidth
					 && -piecesWidth <= my && my <= piecesWidth) {
						cubeDilute(1, gokes[i]);
						//if (action) {
							teban = (i + 1 ) *10;
						//}
					}
				}

				// Update gokes.
				let gx = subScreenWidth / 2;
				let gy = subScreenHeight / 2;
				cubeMove(gx, gy, gokes[i]);
				cubeExpand(1, gokes[i]);
				cubeDilute((i + 1) * 10 == teban ? 0.8 : 0.1, gokes[i]);
				cubeAnimate((i + 1) * 10 + 5, gokes[i]);
			}


			// Clear sub screens.
			for (var i = 0; i < 2; i++) {
				cubeClear(subScreens[i]);

				// Draw gokes.
				cubeDraw(gokes[i], subScreens[i]);
			}

			// Clear main screen.
			cubeClear(mainScreen);

			// Draw gobans
			for (var i = 0; i < level * level; i++) {
				if (i != motionIndex) {
					cubeDraw(gobans[i], mainScreen);
				}
			}
			if (motionIndex >= 0) {
				cubeDraw(gobans[motionIndex], mainScreen);
			}
			if (motion) {
				cubeAnimate(teban + 5, sprite);
				cubeDilute(0.5, sprite);
				cubeExpand(2, sprite);
				cubeMove(motion.x, motion.y, sprite);
				cubeDraw(sprite, mainScreen);
			}

			await cubeWait(10);
		}
	}
})();</script><!--/Main-->
</body>
</html>
